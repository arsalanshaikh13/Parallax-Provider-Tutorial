# default:
#   # global cache for node_modules directory
#   # cache key is based on yarn.lock file.
#   # this ensures cache is only recreated if a dependency is added,updated, or removed

.cache_common: &cache_common
  key:
    files:
      - yarn.lock
  paths:
    - node_modules/

release:
  stage: release
  script:
    - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
    - echo "Publishing version -> $(node -p
      "require('./package.json').version")" # print package version before publishing
    - npm publish --ignore-scripts # ignore running scripts in package.json
    # since publish needs build stage to happen anyway so no need to put the anchor here
    # it will only run if build successfully happens
  needs:
    - build
  cache:
    <<: *cache_common
    policy: pull
  rules:
    - if:
        '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]-gitlabci\.[0-9]+$/ &&
        $CI_PIPELINE_SOURCE == "parent_pipeline"'
      when: on_success
